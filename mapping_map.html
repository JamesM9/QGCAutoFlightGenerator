<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapping Flight - Linear Path</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #1E1E1E;
            color: white;
        }
        
        #map {
            width: 100%;
            height: 100vh;
            background-color: #1E1E1E;
        }
        
        /* Coordinate popup styles (match map.html) */
        .coordinate-popup { 
            font-family: Arial, sans-serif; 
            font-size: 12px; 
            line-height: 1.4; 
        }
        .coordinate-popup .label { 
            font-weight: bold; 
            color: #333; 
        }
        .coordinate-popup .value { 
            color: #666; 
            font-family: 'Courier New', monospace; 
        }
        .elevation-info { 
            margin-top: 8px; 
            padding-top: 8px; 
            border-top: 1px solid #ccc; 
        }
        
        .flight-controls {
            position: absolute !important;
            bottom: 10px !important;
            right: 10px !important;
            background: white !important;
            padding: 15px !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
            z-index: 1000 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            min-width: 150px !important;
        }
        
        .flight-controls h4 {
            margin: 0 0 10px 0 !important;
            color: #333 !important;
            font-size: 14px !important;
            text-align: center !important;
        }
        
        .flight-controls button {
            width: 100% !important;
            margin: 2px 0 !important;
            padding: 8px 12px !important;
            background-color: #007bff !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            font-weight: bold !important;
        }
        
        .flight-controls button:hover {
            background-color: #0056b3 !important;
        }
        
        .flight-controls button:disabled {
            background-color: #6c757d !important;
            cursor: not-allowed !important;
        }
        
        .flight-controls button.clear {
            background-color: #dc3545 !important;
        }
        
        .flight-controls button.clear:hover {
            background-color: #c82333 !important;
        }
        
        .flight-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
            color: #333;
        }
        
        .flight-info h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }
        
        .flight-info p {
            margin: 5px 0;
            font-size: 12px;
        }
        
        .takeoff-marker {
            background-color: #28a745;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .landing-marker {
            background-color: #dc3545;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .waypoint-marker {
            background-color: #007bff;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .leaflet-popup-content-wrapper {
            background-color: #2C2C2C;
            color: white;
            border: 1px solid #555555;
        }
        
        .leaflet-popup-tip {
            background-color: #2C2C2C;
        }
        
        .leaflet-control-layers {
            background-color: #2C2C2C;
            border: 1px solid #555555;
            color: white;
        }
        
        .leaflet-control-layers label {
            color: white;
        }
        
        .leaflet-control-layers input[type="checkbox"] {
            accent-color: #FFD700;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="flight-info">
        <h4>Flight Path Planning</h4>
        <p><strong>Status:</strong> <span id="flight-status">Ready</span></p>
        <p><strong>Takeoff:</strong> <span id="takeoff-status">Not set</span></p>
        <p><strong>Landing:</strong> <span id="landing-status">Not set</span></p>
        <p><strong>Distance:</strong> <span id="flight-distance">0</span> km</p>
    </div>
    
    <div class="flight-controls">
        <h4>Flight Controls</h4>
        <button id="clear-path" class="clear">Clear Path</button>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- QWebChannel JavaScript -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    
    <script>
        // Initialize QWebChannel
        let pywebchannel;
        new QWebChannel(qt.webChannelTransport, function(channel) {
            pywebchannel = channel.objects.pywebchannel;
            console.log('QWebChannel initialized');
        });
        
        // Initialize map
        let map = L.map('map').setView([40.7128, -74.0060], 10);
        
        // Add tile layers with updated sources for the most current maps
        // 1. OpenStreetMap - Latest community-driven street data
        let openStreetMapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });
        
        // 2. CartoDB Positron - Clean, modern street map with latest data
        let cartoPositronLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        });
        
        // 3. CartoDB Voyager - Enhanced street map with more details and latest updates
        let cartoVoyagerLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        });
        
        // 4. High-Resolution Satellite (Esri World Imagery) - Latest satellite imagery
        let satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        });
        
        // 5. Google Satellite - Alternative high-resolution satellite source
        let googleSatelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            attribution: '© Google',
            maxZoom: 20
        });
        
        // 6. Hybrid layer (Satellite + Labels)
        let hybridLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        });
        
        // 7. Hybrid labels layer
        let hybridLabelsLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        });
        
        // 8. Terrain layer with contours and elevation data
        let terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
            maxZoom: 17
        });
        
        // Create layer groups with updated options
        let baseMaps = {
            "OpenStreetMap": openStreetMapLayer,
            "CartoDB Light": cartoPositronLayer,
            "CartoDB Voyager": cartoVoyagerLayer,
            "Satellite (Esri)": satelliteLayer,
            "Satellite (Google)": googleSatelliteLayer,
            "Hybrid": L.layerGroup([hybridLayer, hybridLabelsLayer]),
            "Terrain": terrainLayer
        };
        
        // Add layer control
        L.control.layers(baseMaps).addTo(map);
        
        // Set default layer to Satellite (Google)
        googleSatelliteLayer.addTo(map);
        
        // Flight path variables
        let takeoffPoint = null;
        let landingPoint = null;
        let flightPath = null;
        let takeoffMarker = null;
        let landingMarker = null;
        let waypointMarkers = [];
        
        // Elevation and popup helpers (same as map.html)
        async function getElevation(lat, lng) {
            try {
                const response = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`);
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                    return data.results[0].elevation;
                } else {
                    throw new Error('No elevation data');
                }
            } catch (e) {
                console.error('Elevation fetch error', e);
                return null;
            }
        }

        function formatCoordinates(lat, lng) {
            const latDeg = Math.floor(Math.abs(lat));
            const latMin = (Math.abs(lat) - latDeg) * 60;
            const latSec = (latMin - Math.floor(latMin)) * 60;
            const latDir = lat >= 0 ? 'N' : 'S';
            const lngDeg = Math.floor(Math.abs(lng));
            const lngMin = (Math.abs(lng) - lngDeg) * 60;
            const lngSec = (lngMin - Math.floor(lngMin)) * 60;
            const lngDir = lng >= 0 ? 'E' : 'W';
            return {
                decimal: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                dms: `${latDeg}°${Math.floor(latMin)}'${latSec.toFixed(2)}"${latDir}, ${lngDeg}°${Math.floor(lngMin)}'${lngSec.toFixed(2)}"${lngDir}`
            };
        }

        function createPopupContent(lat, lng, elevation = null) {
            const coords = formatCoordinates(lat, lng);
            let elevationHtml = '';
            
            if (elevation !== null) {
                elevationHtml = `
                    <div class="elevation-info">
                        <div class="label">Elevation:</div>
                        <div class="value">${elevation.toFixed(1)} meters (${(elevation * 3.28084).toFixed(1)} feet)</div>
                    </div>
                `;
            } else if (elevation === null) {
                elevationHtml = `
                    <div class="elevation-info">
                        <div class="loading">Loading elevation data...</div>
                    </div>
                `;
            } else {
                elevationHtml = `
                    <div class="elevation-info">
                        <div class="error">Elevation data unavailable</div>
                    </div>
                `;
            }
            
            return `
                <div class="coordinate-popup">
                    <div class="label">Decimal Coordinates:</div>
                    <div class="value">${coords.decimal}</div>
                    <div class="label">DMS Coordinates:</div>
                    <div class="value">${coords.dms}</div>
                    ${elevationHtml}
                </div>
            `;
        }
        
        // Flight path control functions
        function clearFlightPath() {
            // Remove all markers
            if (takeoffMarker) {
                map.removeLayer(takeoffMarker);
                takeoffMarker = null;
            }
            if (landingMarker) {
                map.removeLayer(landingMarker);
                landingMarker = null;
            }
            waypointMarkers.forEach(function(marker) {
                map.removeLayer(marker);
            });
            waypointMarkers = [];
            
            // Remove flight path
            if (flightPath) {
                map.removeLayer(flightPath);
                flightPath = null;
            }
            
            // Clear points
            takeoffPoint = null;
            landingPoint = null;
            
            // Reset status
            updateFlightStatus('Ready');
            document.getElementById('takeoff-status').textContent = 'Not set';
            document.getElementById('landing-status').textContent = 'Not set';
            document.getElementById('flight-distance').textContent = '0';
            
            // Notify Python
            if (pywebchannel && pywebchannel.clear_path) {
                pywebchannel.clear_path();
            }
        }
        
        function updateFlightStatus(status) {
            document.getElementById('flight-status').textContent = status;
        }
        
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Earth radius in meters
            const lat1Rad = Math.radians(lat1);
            const lng1Rad = Math.radians(lng1);
            const lat2Rad = Math.radians(lat2);
            const lng2Rad = Math.radians(lng2);
            
            const dLat = lat2Rad - lat1Rad;
            const dLng = lng2Rad - lng1Rad;
            
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1Rad) * Math.cos(lat2Rad) * Math.sin(dLng/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        Math.radians = function(degrees) {
            return degrees * Math.PI / 180;
        };
        
        // Map click handler
        map.on('click', async function(e) {
            let lat = e.latlng.lat;
            let lng = e.latlng.lng;
            
            if (!takeoffPoint) {
                // Set takeoff point
                takeoffPoint = {lat: lat, lng: lng};
                
                // Create takeoff marker
                takeoffMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'takeoff-marker',
                        html: '<div style="background-color: #28a745; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [12, 12]
                    })
                }).addTo(map);
                
                updateFlightStatus('Takeoff set - Click to set landing point');
                document.getElementById('takeoff-status').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                
            } else if (!landingPoint) {
                // Set landing point
                landingPoint = {lat: lat, lng: lng};
                
                // Create landing marker
                landingMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'landing-marker',
                        html: '<div style="background-color: #dc3545; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [12, 12]
                    })
                }).addTo(map);
                
                updateFlightStatus('Flight path complete');
                document.getElementById('landing-status').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                
                // Draw flight path
                drawFlightPath();
                
                // Calculate and display distance
                const distance = calculateDistance(takeoffPoint.lat, takeoffPoint.lng, landingPoint.lat, landingPoint.lng);
                document.getElementById('flight-distance').textContent = (distance / 1000).toFixed(2);
                
                // Notify Python
                if (pywebchannel && pywebchannel.receive_path) {
                    pywebchannel.receive_path([takeoffPoint, landingPoint]);
                }
            } else {
                // Show coordinate/elevation popup when flight path is complete
                const popup = L.popup()
                    .setLatLng([lat, lng])
                    .setContent(createPopupContent(lat, lng, null))
                    .openOn(map);
                // Fetch elevation and update popup
                const elevation = await getElevation(lat, lng);
                if (elevation !== null) {
                    popup.setContent(createPopupContent(lat, lng, elevation));
                }
            }
        });
        
        function drawFlightPath() {
            if (!takeoffPoint || !landingPoint) return;
            
            // Create flight path line
            flightPath = L.polyline([takeoffPoint, landingPoint], {
                color: '#007bff',
                weight: 3,
                opacity: 0.8,
                dashArray: '10, 5'
            }).addTo(map);
            
            // Fit map to show both points
            map.fitBounds(flightPath.getBounds(), {padding: [20, 20]});
        }
        
        // Connect button events
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                let clearBtn = document.getElementById('clear-path');
                
                if (clearBtn) clearBtn.addEventListener('click', clearFlightPath);
                
                console.log('Flight controls connected');
            }, 100);
        });
        
        // Function to update flight path from Python backend
        function updateFlightPath(pathData) {
            // Clear existing flight path
            clearFlightPath();
            
            if (pathData.takeoff && pathData.landing) {
                // Set takeoff point
                takeoffPoint = pathData.takeoff;
                takeoffMarker = L.marker([takeoffPoint.lat, takeoffPoint.lng], {
                    icon: L.divIcon({
                        className: 'takeoff-marker',
                        html: '<div style="background-color: #28a745; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [12, 12]
                    })
                }).addTo(map);
                
                // Set landing point
                landingPoint = pathData.landing;
                landingMarker = L.marker([landingPoint.lat, landingPoint.lng], {
                    icon: L.divIcon({
                        className: 'landing-marker',
                        html: '<div style="background-color: #dc3545; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [12, 12]
                    })
                }).addTo(map);
                
                // Draw flight path
                drawFlightPath();
                
                // Update status
                updateFlightStatus('Flight path loaded');
                document.getElementById('takeoff-status').textContent = `${takeoffPoint.lat.toFixed(4)}, ${takeoffPoint.lng.toFixed(4)}`;
                document.getElementById('landing-status').textContent = `${landingPoint.lat.toFixed(4)}, ${landingPoint.lng.toFixed(4)}`;
                
                // Calculate and display distance
                const distance = calculateDistance(takeoffPoint.lat, takeoffPoint.lng, landingPoint.lat, landingPoint.lng);
                document.getElementById('flight-distance').textContent = (distance / 1000).toFixed(2);
                
                // Add waypoint markers if available
                if (pathData.path && pathData.path.length > 0) {
                    pathData.path.forEach(function(waypoint, index) {
                        if (index > 0 && index < pathData.path.length - 1) { // Skip first and last points
                            let marker = L.marker([waypoint.lat, waypoint.lng], {
                                icon: L.divIcon({
                                    className: 'waypoint-marker',
                                    html: '<div style="background-color: #007bff; width: 8px; height: 8px; border-radius: 50%; border: 2px solid white;"></div>',
                                    iconSize: [8, 8]
                                })
                            }).addTo(map);
                            waypointMarkers.push(marker);
                        }
                    });
                }
            }
        }
        
        // Initialize status
        updateFlightStatus('Ready');
    </script>
</body>
</html>
